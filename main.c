#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <ctype.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <ncurses.h>
#include "text_editor.h"
#include "memory.h"
#include "config.h"
#include "thoth.h"
#include "x11.h"

enum {
	THOTH_STATE_QUIT = 1,
	THOTH_STATE_UPDATE,
	THOTH_STATE_UPDATEDRAW,
	THOTH_STATE_RUNNING,
};

#define MOUSEUPDATETIME 50


#ifndef LIBRARY_COMPILE
// #ifdef LINUX_COMPILE || WINDOWS_COMPILE

static char configpath_g[MAX_PATH_LEN];

char *Thoth_GetConfigPath(char *relpath){
#if LINUX_COMPILE
	char *path = getenv("HOME");
#elif WINDOWS_COMPILE
	char *path = getenv("APPDATA");
#endif
	if(relpath == NULL)
		sprintf(configpath_g,"%s%s",path,THOTH_CONFIG_PATH);
	else
		sprintf(configpath_g,"%s%s",path,relpath);
	// ignored if exists
	return configpath_g;
}
// #endif 
#endif


// static void MouseMotionUpdate(Thoth_t *t){
// 	int mousetime = SDL_GetTicks() - t->mousemotiontime;
// 	if(mousetime > MOUSEUPDATETIME) {
// 		int mouseupdate = Thoth_Editor_SetCursorPosSelection(&t->te, t->mousex, t->mousey);
// 		if(mouseupdate){
// 			t->state = THOTH_STATE_UPDATEDRAW;
// 			t->mousemotiontime = SDL_GetTicks(); //because timeout, we only wanna see if its been since the
// 		}
// 	}
// }

#ifdef LIBRARY_COMPILE
void Event(Thoth_t *t, SDL_Event ev){
#else
void Event(Thoth_t *t){
//	SDL_Event ev;
//	if(t->te.logging == THOTH_LOGMODE_CONSOLE){
//		if(!SDL_WaitEventTimeout(&ev, 1000)){
//			t->state = THOTH_STATE_UPDATEDRAW;
//			return;
//		}
//	} else if(t->mousedown){
//		if(!SDL_WaitEventTimeout(&ev,MOUSEUPDATETIME)){
//			MouseMotionUpdate(t);
//			return;
//		}
//	} else {
//		if(!SDL_WaitEvent(&ev)) return;
//	}
#endif
	XEvent ev;
	X11_NextEvent(&ev,t->te.clipboard);

	if(ev.type == FocusIn){ 
		t->key = 0;
	}

	if(ev.type == KeyPress){
		
		int key = t->key & THOTH_ENTER_KEY ? t->key ^ THOTH_ENTER_KEY : t->key;
		char *str = XKeysymToString(XLookupKeysym(&ev.xkey,0));

		KeySym keysym;
		Status status;
		char buf[16];
		int c = Xutf8LookupString(X11_GetIC(), &ev.xkey, buf, 15,&keysym, &status);
		Xutf8LookupString(X11_GetIC(), &ev.xkey, buf, c,&keysym, &status);

		if(strcmp(str, "Control_L") == 0) key |= THOTH_CTRL_KEY;
		else if(strcmp(str, "Control_R") == 0) key |= THOTH_CTRL_KEY;
		else if(strcmp(str, "Alt_L") == 0) key |= THOTH_ALT_KEY;
		else if(strcmp(str, "Alt_R") == 0) key |= THOTH_ALT_KEY;
		else if(strcmp(str, "Shift_L") == 0) key |= THOTH_SHIFT_KEY;
		else if(strcmp(str, "Shift_R") == 0) key |= THOTH_SHIFT_KEY;
		else if(strcmp(str, "Return") == 0) key |= THOTH_ENTER_KEY;
		else if(strcmp(str, "Tab") == 0) key = 9;
		else if(strcmp(str, "Escape") == 0) key = 27;
		else if(strcmp(str, "BackSpace") == 0) key = 127;
		else if(strcmp(str, "slash") == 0) key = (key&0xFF00)|'/';
		else if(strcmp(str, "bracketleft") == 0) key = (key&0xFF00)|'[';
		else if(strcmp(str, "bracketright") == 0) key = (key&0xFF00)|']';
		else if(strcmp(str, "Right") == 0) key |= THOTH_ARROW_RIGHT;
		else if(strcmp(str, "Left") == 0) key |= THOTH_ARROW_LEFT;
		else if(strcmp(str, "Up") == 0) key |= THOTH_ARROW_UP;
		else if(strcmp(str, "Down") == 0) key |= THOTH_ARROW_DOWN;
		else if(strcmp(str, "") == 0) key |= THOTH_ARROW_DOWN;
		else 
			key = (key&0xFF00) | (str[0] & 0xFF);

		if((key & THOTH_CTRL_KEY) == 0 && key != 127 && key != 27 && key != 9) 
			key = (key&0xFF00) | (buf[0] & 0xFF);


		t->key = key;
		t->state = THOTH_STATE_UPDATE;     

	} else if(ev.type == KeyRelease) {
		char *str = XKeysymToString(XLookupKeysym(&ev.xkey,0));
		if(strcmp(str, "Control_R") == 0) t->key ^= THOTH_CTRL_KEY;
		else if(strcmp(str, "Control_L") == 0) t->key ^= THOTH_CTRL_KEY;
		else if(strcmp(str, "Alt_L") == 0) t->key ^= THOTH_ALT_KEY;
		else if(strcmp(str, "Alt_R") == 0) t->key ^= THOTH_ALT_KEY;
		else if(strcmp(str, "Shift_L") == 0) t->key ^= THOTH_SHIFT_KEY;
		else if(strcmp(str, "Shift_R") == 0) t->key ^= THOTH_SHIFT_KEY;
		else if(strcmp(str, "Return") == 0) t->key ^= THOTH_ENTER_KEY;
		else if(strcmp(str, "Right") == 0) t->key ^= THOTH_ARROW_RIGHT;
		else if(strcmp(str, "Left") == 0) t->key ^= THOTH_ARROW_LEFT;
		else if(strcmp(str, "Up") == 0) t->key ^= THOTH_ARROW_UP;
		else if(strcmp(str, "Down") == 0) t->key ^= THOTH_ARROW_DOWN;
	}
//#ifndef LIBRARY_COMPILE
//	} else if(ev.type == SDL_EVENT_WINDOW_RESIZED || ev.type == SDL_EVENT_WINDOW_PIXEL_SIZE_CHANGED){
//		Thoth_Graphics_ViewportXY(&t->graphics, 0, 0);
//		Thoth_Graphics_Resize(&t->graphics, ev.window.data1, ev.window.data2);
//		Thoth_Graphics_Clear(&t->graphics);
//		Thoth_Editor_Draw(&t->te);        
//		Thoth_Graphics_Render(&t->graphics);
//		Window_Swap();
//#endif
}


#ifndef LIBRARY_COMPILE
int main(int argc, char **argv){
	Thoth_t t;
	memset(&t,0,sizeof(Thoth_t));

#ifdef LINUX_COMPILE
	mkdir(Thoth_GetConfigPath(NULL), S_IRWXU | S_IRWXG | S_IROTH | S_IXOTH);
#endif

	Thoth_Config_Read(&t.cfg);


	Thoth_Editor_Init(&t.te, &t.cfg);
	X11_Init();
	if(argc > 1){
		int k;
		for(k = 0; k < argc-1; k++)
			Thoth_Editor_LoadFile(&t.te, argv[1+k]);
	}
	else if(t.te.nFiles == 0)
		Thoth_Editor_LoadFile(&t.te, NULL);


	// u32 currTime;
	// u32 frames = 0;
	// u32 lastSecond = SDL_GetTicks();
	  wclear(stdscr);

   Thoth_Editor_Draw(&t.te);        

	while(t.state != THOTH_STATE_QUIT){

	   // currTime = SDL_GetTicks();

	   // int fps;
	   // float frameTime;
	   // if(currTime - lastSecond > 1000){
	   //     fps = frames;
	   //     frameTime = (currTime - lastSecond) / (float)frames;
	   //     lastSecond = currTime;
	   //     frames = 0;
		   // printf("fps: %i | ms: %f\n", fps, frameTime);
	   // }

	   // ++frames;

	   Event(&t);

	   if(t.state == THOTH_STATE_QUIT){
			if(!Thoth_Editor_Destroy(&t.te))
				t.state = THOTH_STATE_UPDATEDRAW;
	   }

	   if(t.state == THOTH_STATE_UPDATE || t.state == THOTH_STATE_UPDATEDRAW){

		   if(t.state == THOTH_STATE_UPDATE){
			   int key = t.key;

			   if((t.key >> 8) == (THOTH_SHIFT_KEY >> 8)){
				   key = (t.key & 0xFF);
			   }
			   Thoth_Editor_Event(&t.te, key);
				if(t.te.quit){
					if(Thoth_Editor_Destroy(&t.te) > 0){
						break;
					}
					t.te.quit = 0;
				}

			   t.key = t.key & 0xff00;

			   Thoth_Editor_Draw(&t.te);        
			}    
		   t.state = THOTH_STATE_RUNNING;

	   }
	}
	X11_WithdrawWindow();
	X11_Close();
	wclear(stdscr);
	wrefresh(stdscr);
	endwin();
	return 0;
}
#endif
